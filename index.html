<center>
    <canvas id="ctx" width="500" height="600" style="border:1px solid #000000;"></canvas>
</center>
    
<style>

</style>

<script>
    var ctx = document.getElementById("ctx").getContext("2d");
    ctx.font = '20px Arial';

    const HEIGHT = 600;
    const WIDTH = 500;
    var survivedTime = 0;
    var randomAppearanceTimer = 0;


    var Map = {}
    Map.roadImg = new Image();
    Map.roadImg.src = 'img/road2.jpg';
    Map.grass = new Image();
    Map.grass.src = 'img/grass.jpg';

    var ImgPlayer = {}
    ImgPlayer.auto = new Image();
    ImgPlayer.auto.src = 'img/playerAuto.png';

    var ImgTraffic = {}
    ImgTraffic.counter = new Image();
    ImgTraffic.counter.src = 'img/counterAuto.png';

    ImgTraffic.follow = new Image();
    ImgTraffic.follow.src = 'img/followAuto.png';

    var player = {
        x: 300,
        spdX: 0,
        y: 470,
        spdY: 0,
        name: 'P',
        width: ImgPlayer.auto.width,
        height: ImgPlayer.auto.height,
        color: 'green',
        image: ImgPlayer.auto,
        hp: 10,
        pressingUp: false,
        pressingDown: false,
        pressingLeft: false,
        pressingRight: false,
    };

    var trafficList = {};

    getDistanceBetweenEntity = function (entity1, entity2) {
        var vx = entity1.x - entity2.x;
        var vy = entity1.y - entity2.y;
        return Math.sqrt(vx * vx + vy * vy);
    }

    testCollisionEntity = function (entity1, entity2) {
        var rect1 = {
            x: entity1.x / 2,
            y: entity1.y / 2,
            width: 25,
            height: 45,
        }
        var rect2 = {
            x: entity2.x / 2,
            y: entity2.y / 2,
            width: 25,
            height: 45,
        }
        return testCollisionRectRect(rect1, rect2)
    }

    drawEntity = function (arg) {
        ctx.save();
        ctx.fillStyle = arg.color;
        // ctx.fillRect(arg.x - arg.width / 2, arg.y - arg.height / 2, arg.width, arg.height);
        ctx.drawImage(arg.image,arg.x,arg.y);
        ctx.restore();
    }

    Traffic = function (id, x, y, spdX, spdY, width, height, image) {
        var traffic = {
            x: x,
            spdX: spdX,
            y: y,
            spdY: spdY,
            name: 'T',
            id: id,
            width: width,
            height: height,
            color: 'red',
            image: image,
        };
        trafficList[id] = traffic;
    }

    updateEntity = function (arg) {
        updateEntityPosition(arg);
        drawEntity(arg);
    }

    updateEntityPosition = function (arg) {
        arg.x += arg.spdX;
        arg.y += arg.spdY;

        if (arg.y < 0 || arg.y > HEIGHT) {
            arg = null;
        }
    }

    testCollisionRectRect = function (rect1, rect2) {
        return rect1.x <= rect2.x + rect2.width &&
            rect2.x <= rect1.x + rect1.width &&
            rect1.y <= rect2.y + rect2.height &&
            rect2.y <= rect1.y + rect1.height;
    }

    update = function () {
        ctx.clearRect(0, 0, WIDTH, HEIGHT);
       
        //drawing gaming map temporary
        ctx.fillStyle = 'black';
        // ctx.fillRect(WIDTH / 2 - WIDTH / 4, 0, WIDTH / 2, HEIGHT);
        // var roadImg = document.getElementById('road')
        // ctx.drawImage(roadImg, WIDTH/2 - WIDTH/4,0 , WIDTH/2, HEIGHT);
        ctx.drawImage(Map.grass, 0, 0, WIDTH, HEIGHT);

        ctx.drawImage(
        Map.roadImg,      //src

        0,    //координаты верхнего левого угла слайса относительно изображения;
        0,                    // -/-/-

        900,             // размеры слайса
        HEIGHT,            // -/-/-

        WIDTH/2 - WIDTH/4,                 // координаты верхнего левого угла обрезанного изображения;
        0,                  // -/-/-

        WIDTH/2,            // размеры обрезанного изображения на холсте.
        HEIGHT,              // -/-/-


        );

        ctx.fillStyle = 'white';
        // ctx.fillRect(WIDTH / 2 + 2, 0, 2, HEIGHT);
        survivedTime++;

        for (var key in trafficList) {
            updateEntity(trafficList[key]);

            var isCollidingPlayerTraffic = testCollisionEntity(player, trafficList[key]);
            if (isCollidingPlayerTraffic) {
                player.hp = player.hp - 1;
                    delete trafficList[key]

                // currentTraffic = trafficList[key];
                // currentTraffic.height = 0;
                // currentTraffic.width = 0;
                if (player.hp <= 0) {
                    console.log('you lost! your score: ' + survivedTime + ' points');
                    player.hp = 10;
                    survivedTime = 0;
                }
            }
        }

        updatePlayerPosition();
        drawEntity(player);
        ctx.fillStyle = 'blue';
        ctx.fillText(player.hp + ' hp', 0, 30);
        ctx.fillText('score: ' + survivedTime, WIDTH - 100, 30);
        var randomAppearanceTimer = Math.random();
        if (randomAppearanceTimer < 0.01) {
            // setInterval(randomCounterTrafficGeneration,1000);
            randomCounterTrafficGeneration();
            // randomCounterTrafficGeneration = null;
        } else if (randomAppearanceTimer > 0.99) {
            randomFollowingTrafficGeneration()
        }
    }

    document.onkeydown = function (event) {
        if (event.keyCode === 39) //d
            player.pressingRight = true;
        else if (event.keyCode === 40) //s
            player.pressingDown = true;
        else if (event.keyCode === 37) //a
            player.pressingLeft = true;
        else if (event.keyCode === 38) // w
            player.pressingUp = true;
    }

    document.onkeyup = function (event) {
        if (event.keyCode === 39) //d
            player.pressingRight = false;
        else if (event.keyCode === 40) //s
            player.pressingDown = false;
        else if (event.keyCode === 37) //a
            player.pressingLeft = false;
        else if (event.keyCode === 38) // w
            player.pressingUp = false;
    }

    updatePlayerPosition = function () {
        if (player.pressingUp)
            player.y -= 10;
        if (player.pressingRight)
            player.x += 20;
        if (player.pressingLeft)
            player.x -= 20;
        if (player.pressingDown)
            player.y += 10;
    }

    //UNOPTIMIZED YET!!
    randomCounterTrafficGeneration = function () {
        var id = Math.random();
        var x = WIDTH / 2 - 70 - 20 * Math.random();
        var y = 0; //temporary
        var width = 60;
        var height = 90;
        var image = ImgTraffic.counter;
        var spdY = 15 //+ Math.random()*10;
        var spdX = 0; //dont turn to sides 
        Traffic(id, x, y, spdX, spdY, width, height, image);
    }

    randomFollowingTrafficGeneration = function () {
        var id = Math.random();
        var x = WIDTH / 2 + 30 + 20 * Math.random();
        var y = 0; //temporary
        var width = 60;
        var height = 90;
        var image = ImgTraffic.follow;
        var spdY = 5 //+ Math.random()*5;
        var spdX = 0; //dont turn to sides 
        Traffic(id, x, y, spdX, spdY, width, height, image);
    }


    // setInterval(randomCounterTrafficGeneration, randomAppearanceTimer);
    // setInterval(randomFollowingTrafficGeneration, randomAppearanceTimer);

    setInterval(update, 20);

</script>