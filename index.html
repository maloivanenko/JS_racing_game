<div class="leftContainer">
    <span class="hp">Car durability:</span>
    <progress id="health" value="5" max="5"></progress>
    <span id="timer" class="score">Score: </span>
</div>
<center>
    <div id="menu">
       <span class="disclaimer">TO START OR RESUME CURRENT GAME PRESS <img src="img/enter.png"> <br><br>
    TO MOVE THE CAR USE <img src="img/arrows.png"></span>
    </div>
    <div id="gameover" class="hidden">
        <span id="finishscreen" class="disclaimer">GAME OVER<br>PRESS<img src="img/enter.png"> TO RESTART</span>
    </div>
    <canvas id="ctx" width="500" height="600" style="border:5px solid #000000;">
    </canvas>
</center>

<style>
    body {
        background: #444;
        margin: 0;
        padding: 0;
        font-family: "Lucida Bright", Georgia, serif;
        background-image: url('img/background.jpg');
        /* filter: blur(2px); */
    }
    #ctx {
        background-image: url('img/road_with_grass2.jpg');
        background-repeat: repeat-y;
        background-size: 100%;
        position: initial;
        background-position-y: 0;
        margin-top: 10px;
        box-shadow: 1px 0px 46px 8px rgba(0, 0, 0, 0.75);
    }

    #menu, #gameover {
        width: 100%;
        height: 100%;
        background-color: gray;
        position:absolute;
        opacity: 0.8;
        box-shadow: 1px 0px 46px 8px rgba(0, 0, 0, 0.75), 0 1px 5px #000 inset, 0 1px 0 #444;
        overflow: hidden;
    }
    .hidden {
        visibility: hidden;
    }

    .disclaimer{
        position: absolute;
        font-size: 25px;
        width: 50%;
        height: 30%;
        top: 15%;
        left: 25%;
    }
    .leftContainer {
        position: fixed;
        width: 200px;
        height: 600px;
    }

    progress {
        position: absolute;
        margin-top: 25px;
        margin-left: 10px;
        height: 30px;
        padding: 5px;
        width: 170px;
        background-color: #1a1a1a;
        border-radius: 5px;
        box-shadow: 0 1px 5px #000 inset, 0 1px 0 #444;
    }

    progress::-webkit-progress-bar {
        background-color: #1a1a1a;
    }

    progress::-webkit-progress-value {
        background-color: #34c2e3;
        background-size: 30px 30px;
        background-image: -webkit-linear-gradient(top left, rgba(255, 255, 255, .15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .15) 50%, rgba(255, 255, 255, .15) 75%, transparent 75%, transparent);
        background-image: -moz-linear-gradient(top left, rgba(255, 255, 255, .15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .15) 50%, rgba(255, 255, 255, .15) 75%, transparent 75%, transparent);
        background-image: -o-linear-gradient(top left, rgba(255, 255, 255, .15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .15) 50%, rgba(255, 255, 255, .15) 75%, transparent 75%, transparent);
        background-image: linear-gradient(to bottom right, rgba(255, 255, 255, .15) 25%, transparent 25%, transparent 50%, rgba(255, 255, 255, .15) 50%, rgba(255, 255, 255, .15) 75%, transparent 75%, transparent);
        animation: animate-stripes 3s linear infinite;
    }

    .hp,
    .score {
        position: absolute;
        margin-top: 5px;
        margin-left: 15px;
        color: white;
    }

    .score {
        margin-top: 60px;
    }


</style>

<!-- 
to do list: 
    -pause when user change brows tab
    -upgrades, hp bar, speed(steering)
    -random traffic car model(car/truck, color, speed)          /+/
    -adding road reconstruction work or bad road segments
    -engrain pause option, pause when onfocus window
    -implementing physics 
    -adding sounds 
-->

<script src="https://cdn.jsdelivr.net/lodash/4.17.4/lodash.min.js"></script>
<script>
    var ctx = document.getElementById("ctx").getContext("2d");
    var menu = document.getElementById("menu");
    var gameover = document.getElementById("gameover");
    ctx.font = '20px Arial';
    var statement = 'paused';

    const HEIGHT = 600;
    const WIDTH = 500;
    var survivedTime = 0;

    var Map = {}
    Map.roadImg = new Image();
    Map.roadImg.src = 'img/road2.jpg';
    Map.grass = new Image();
    Map.grass.src = 'img/grass.jpg';

    var ImgPlayer = {}
    ImgPlayer.auto = new Image();
    ImgPlayer.auto.src = 'img/playerAuto.png';

    ImgPlayer.repair = new Image();
    ImgPlayer.repair.src = 'img/repair.png';

    ImgPlayer.upgrade = new Image();
    ImgPlayer.upgrade.src = 'img/upgrade.png';


    var ImgTraffic = {}
    ImgTraffic.models = new Image();
    ImgTraffic.models.src = 'img/autos.png'


    var player = {
        x: 300,
        spdX: 0,
        y: 470,
        spdY: 0,
        image: ImgPlayer.auto,
        width: ImgPlayer.auto.width,
        height: ImgPlayer.auto.height,
        type: 'player',
        model: 'default',
        hp: 5,
        deg: 10,
        pressingUp: false,
        pressingDown: false,
        pressingLeft: false,
        pressingRight: false,
    };
    let health = document.getElementById("health");

    var trafficList = {};
    var repairList = {};
    var upgradeList = {};

    getDistanceBetweenEntity = function (entity1, entity2) {
        var vx = entity1.x - entity2.x;
        var vy = entity1.y - entity2.y;
        return Math.sqrt(vx * vx + vy * vy);
    }

    testCollisionEntity = function (entity1, entity2) {
        var rect1 = {
            x: entity1.x / 2,
            y: entity1.y / 2,
            width: 20,
            height: 45,
        }
        var rect2 = {
            x: entity2.x / 2,
            y: entity2.y / 2,
            width: 20,
            height: 45,
        }
        return testCollisionRectRect(rect1, rect2)
    }

    drawEntity = function (arg) {
        ctx.save();
        //drawImage(image, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight)
        if (arg.type === 'player') {
            ctx.drawImage(arg.image, arg.x, arg.y);
        } else if (arg.type === 'counter' || arg.type === 'follow') {
            ctx.drawImage(arg.image, arg.sliceX, arg.sliceY, 47.25, 85, arg.x, arg.y, 49, 85);
        }
        // 


        // ctx.drawImage(arg.image,sliceX,sliceY,49,89,arg.x,arg.y,49,89);


        //ctx.drawImage(arg.image,0,89,49,89,arg.x,arg.y,49,89);



        // if(arg.type !== 'player' && arg.model > 2){
        //     ctx.drawImage(arg.image,0,0,49,89,arg.x,arg.y,49,89); 
        // } else {
        //     ctx.drawImage(arg.image,49,0,49,89,arg.x,arg.y,49,89); 
        // }
        ctx.restore();
    }


    Traffic = function (id, x, y, spdX, spdY, width, height, type, model, color, image, sliceX, sliceY) {
        var traffic = {
            x: x,
            spdX: spdX,
            y: y,
            spdY: spdY,
            name: 'T',
            id: id,
            width: width,
            height: height,
            type: type,
            model: model,
            color: color,
            image: image,
            sliceX: sliceX,
            sliceY: sliceY,
        };
        trafficList[id] = traffic;
    }

    Repair = function (id, x, y, spdX, spdY, width, height) {
        var rep = {
            id: id,
            x: x,
            y: y,
            spdX: spdX,
            spdY: spdY,
            width: width,
            height: height,
        };
        repairList[id] = rep;
    }

    Upgrade = function (id, x, y, spdX, spdY, width, height) {
        var up = {
            id: id,
            x: x,
            y: y,
            spdX: spdX,
            spdY: spdY,
            width: width,
            height: height,
        };
        upgradeList[id] = up;
    }

    updateEntity = function (arg) {
        updateEntityPosition(arg);
        drawEntity(arg);
    }

    updateEntityPosition = function (arg) {
        arg.x += arg.spdX;
        arg.y += arg.spdY;

        if (arg.y < 0 || arg.y > HEIGHT) {
            arg = null;
        }
    }

    testCollisionRectRect = function (rect1, rect2) {
        return rect1.x <= rect2.x + rect2.width &&
            rect2.x <= rect1.x + rect1.width &&
            rect1.y <= rect2.y + rect2.height &&
            rect2.y <= rect1.y + rect1.height;
    }

    // togglePause = function(){
    //     if (!started){
    //     started = true;
    // } else if (started){
    //    clearInterval(update)
    //    started = false;
    // }
    // }


    update = function () {
        ctx.clearRect(0, 0, WIDTH, HEIGHT);
        survivedTime++;

        for (var key in trafficList) {
            updateEntity(trafficList[key]);
            var currentKey = key;
            trafficList[currentKey].spdX += _.random(-0.01, 0.01);
            if (trafficList[currentKey].x >= 350) {
                trafficList[currentKey].x = 350;
            } else if (trafficList[currentKey].x <= 100) {
                trafficList[currentKey].x = 100;
            }

            var isCollidingPlayerTraffic = testCollisionEntity(player, trafficList[key]);
            // var isCollidingTrafficTraffic = testCollisionEntity(trafficList[key]);

            if (isCollidingPlayerTraffic) {
                player.hp = player.hp - 1;
                health.value -= 1;
                var currentKey1 = key;

                player.x = player.x + _.random(-15, 15) * Math.random();
                player.y = player.y + _.random(10, 15);
                trafficList[currentKey].spdX += _.random(-5, 5);
                trafficList[currentKey].spdY += _.random(-10, -5);
                setInterval(function () {
                        delete trafficList[currentKey1];
                    },
                    120);

                if (player.hp <= 0) {
                    console.log('you lost! your score: ' + survivedTime + ' points');
                    player.hp = 5;
                    player.x = 300;
                    player.y = 470;
                    health.value = 5;
                    survivedTime = 0;
                    stop();
                }
            }

            // if (isCollidingTrafficTraffic) {
            //     console.log('dtp')
            // }
        }

        if (player.x > 350) {
            player.x = 350;
        } else if (player.x < 100) {
            player.x = 100;
        } else if (player.y > HEIGHT - 90) {
            player.y = HEIGHT - 90;
        } else if (player.y <= 0) {
            player.y = 0;
        }
        updatePlayerPosition();
        drawEntity(player);
        document.getElementById('timer').innerText = 'Score: ' + survivedTime;
    }

    movingBackground = function () {
        document.getElementById('ctx').style.backgroundPositionY = 8 * survivedTime + 'px';
    }
    setInterval(movingBackground, 5);

    // counterTimer = setTimeout(function timerForCounterTraffic() {
    //     randomCounterTrafficGeneration();
    //     var timer = 200+Math.random()*1000
    //     counterTimer = setTimeout(timerForCounterTraffic, timer);
    // }, 1000);

    // followTimer = setTimeout(function timerForFollowTraffic() {
    //     randomFollowingTrafficGeneration();
    //     var timer = 1500+Math.random()*2000
    //     followTimer = setTimeout(timerForFollowTraffic, timer);
    // }, 1000);

    document.onkeydown = function (event) {
        if (event.keyCode === 39) //d
            player.pressingRight = true;
        else if (event.keyCode === 40) //s
            player.pressingDown = true;
        else if (event.keyCode === 37) //a
            player.pressingLeft = true;
        else if (event.keyCode === 38) // w
            player.pressingUp = true;
        else if (event.keyCode === 13) {
            switch (statement) {
                case 'paused':
                    start();
                    break;
                case 'running':
                    stop();
                default:break;
            }
        }
    }

    document.onkeyup = function (event) {
        if (event.keyCode === 39) //d
            player.pressingRight = false;
        else if (event.keyCode === 40) //s
            player.pressingDown = false;
        else if (event.keyCode === 37) //a
            player.pressingLeft = false;
        else if (event.keyCode === 38) // w
            player.pressingUp = false;      
    }

    updatePlayerPosition = function () {
        if (player.pressingUp)
            player.y -= 5;
        if (player.pressingRight)
            player.x += 5;
        player.deg += 5;
        if (player.pressingLeft)
            player.x -= 5;
        player.deg += -5;
        if (player.pressingDown)
            player.y += 5;
    }

    // const startGame = setInterval(update,20);
    startCounterTimer = function () {
        for (var key in trafficList) {
            delete trafficList[key];
        }
        counterTimer = setTimeout(function timerForCounterTraffic() {
            randomCounterTrafficGeneration();
            var timer = 200 + Math.random() * 1000
            return counterTimer = setTimeout(timerForCounterTraffic, timer);
        }, 1000);

        startFollowTimer = function () {
            for (var key in trafficList) {
                delete trafficList[key];
            }
            followTimer = setTimeout(function timerForFollowTraffic() {
                randomFollowingTrafficGeneration();
                var timer = 1500 + Math.random() * 2000
                return followTimer = setTimeout(timerForFollowTraffic, timer);
            }, 1000);
        }

    }
    start = function () {
        menu.classList.add('hidden');
        gameover.classList.add('hidden');
        startCounterTimer();
        startFollowTimer();
        statement = 'running';
        for (var key in trafficList) {
            delete trafficList[key];
        }
        return startGame = setInterval(update, 20);

    }


    stop = function () {
        gameover.classList.remove('hidden');
        survivedTime = 0;
        for (var key in trafficList) {
            delete trafficList[key];
        }
        player.hp = 5;
        player.x = 300;
        player.y = 470;
        statement = 'paused';
        clearInterval(startGame);
        clearTimeout(counterTimer);
        clearTimeout(followTimer);
    }

    //UNOPTIMIZED YET!!
    randomCounterTrafficGeneration = function () {
        var id = Math.random();
        var x0 = _.random(0, 1);
        if (x0 > 0.5) {
            x = 100;
        } else {
            x = 181;
        }
        var y = -90; //temporary
        var width = 60;
        var height = 90;
        var type = 'counter';
        var model = _.random(1, 3);
        var color = _.random(1, 4)
        var image = ImgTraffic.models;
        var spdY = 15 //+ Math.random()*10;
        var spdX = 0; //dont turn to sides 
        var sliceX = _.random(1, 12) * 47.25;
        var sliceY = 0;
        Traffic(id, x, y, spdX, spdY, width, height, type, model, color, image, sliceX, sliceY);
    }

    randomFollowingTrafficGeneration = function () {
        var id = Math.random();
        var x0 = _.random(0, 1);
        if (x0 > 0.5) {
            x = 267;
        } else {
            x = 345;
        }
        var y = -90; //temporary
        var width = 60;
        var height = 90;
        var type = 'follow';
        var model = _.random(1, 3);
        var color = _.random(1, 4)
        var image = ImgTraffic.models;
        var spdY = 2 //+ Math.random()*5;
        var spdX = _.random(-0.1, 0.1); //dont turn to sides 
        var sliceX = _.random(1, 12) * 47.25;
        var sliceY = 85;
        Traffic(id, x, y, spdX, spdY, width, height, type, model, color, image, sliceX, sliceY);
    }
</script>